# Мануал
## Подготовка сервера
### Обновление репозитория и upgrade пакетов до текущих версий
```sh
apt update && apt dist-upgrade -y
```

### Задаём имя сервера
```sh
hostnamectl set-hostname mednotesrv && reboot
```

### Установка необходимых для работы пакетов
```sh
apt install -y git build-essential libssl-dev libffi-dev sshpass python3-virtualenv python3-dev dos2unix screen libpq-dev
```

### Установка БД PostgeSQL
```sh
apt install -y postgresql postgresql-contrib
```

### Выставляем правильный часовой пояс
```sh
timedatectl set-timezone Europe/Moscow
```

### Добавляем русскую локаль
```sh
locale-gen "ru_RU.UTF-8"
```
```sh
localectl set-locale LANG=ru_RU.UTF-8
```

### Настройка firewall
#### разрешаем все исходящие соединения
```sh
ufw default allow outgoing
```
#### разрешаем доступ к ssh для вашего внешнего ip
```sh
ufw allow from ВАШ_ВНЕШНИЙ_IP to any port 22
```
#### если есть локальная сеть, то и для неё можно открыть доступ к ssh
```sh
ufw allow from 192.168.201.0/24 to any port 22
```
#### включаем ufw
```sh
ufw enable
```
#### проверяем настрйоки
```sh
ufw status
```


## подготовка БД
### создадаём пользователя и БД
```sh
sudo su - postgres
```
```sh
createuser dbuser
```
```sh
createuser dbuser
```
### создаём необходимые таблицы
```sql
CREATE TABLE IF NOT EXISTS tb_customers (
    id               SERIAL PRIMARY KEY,
    tid              INTEGER DEFAULT 0,
    age              SMALLINT NULL,
    is_doctor        SMALLINT  DEFAULT 0,
    is_notify        SMALLINT  DEFAULT 1,
    is_administrator SMALLINT  DEFAULT 0,
    is_superuser     SMALLINT  DEFAULT 0,
    phonenumber      VARCHAR(20) UNIQUE NOT NULL,
    car_plate        VARCHAR(20) NULL,
    lastname         VARCHAR(50) NULL,
    name             VARCHAR(50) NULL,
    surname          VARCHAR(50) NULL,
    spreadsheet_id   VARCHAR(255) NULL,
    date_birth       TIMESTAMP NULL,
    date_reg         TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE TABLE IF NOT EXISTS tb_files (
    id          SERIAL PRIMARY KEY,
    cid         INTEGER     NOT NULL,
    file_id     VARCHAR(255) UNIQUE NOT NULL,
    file_type   VARCHAR(15) NOT NULL,
    created     TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE TABLE IF NOT EXISTS tb_appointments (
    id              SERIAL PRIMARY KEY,
    cid             INT NOT NULL,         -- client id - id клиента в таблице tb_customers
    doctor_id       INT NOT NULL,
    appt_format     VARCHAR(15) NOT NULL, --   формат записи online, offline, closed
    description     VARCHAR(255) NULL,
    is_approved     SMALLINT DEFAULT 0, --     запись подтверждена
    is_notified     SMALLINT DEFAULT 0, --     клиенту послан запрос подтверждения
    is_closed       SMALLINT DEFAULT 0, --     день закрыт для записи
    appt_date       TIMESTAMP UNIQUE NOT NULL, --     дата записи
    approve_date    TIMESTAMP NULL, --     дата пациент подтвердил запись
    notify_date     TIMESTAMP NULL --     дата оповещения
);

ALTER TABLE tb_appointments ADD CONSTRAINT fk_tb_appointments_cid FOREIGN KEY (cid) REFERENCES tb_customers (id) ON DELETE CASCADE ON UPDATE CASCADE;
ALTER TABLE tb_files ADD CONSTRAINT fk_tb_files_cid FOREIGN KEY (cid) REFERENCES tb_customers (id) ON DELETE CASCADE ON UPDATE CASCADE;

ALTER TABLE tb_appointments OWNER TO dbuser;
ALTER TABLE tb_files OWNER TO dbuser;
ALTER TABLE tb_customers OWNER TO dbuser;
```


## установка бота
### скачиваем из гита нашего бота
```sh
git clone -b master https://github.com/kuromaster/mednotebot.git /opt/mednotebot
```

### создаём виртуальное окружение и активируем его
```sh
cd /opt/mednotebot && virtualenv venv && source /opt/mednotebot/venv/bin/activate
```

### устанавливаем пакеты из файла requirements.txt
```sh
pip3 install -r requirements.txt
```

### создаём недостающие каталоги
```sh
mkdir -p {cred,config}
```

### правим .env по пути /opt/mednotebot/config
```conf
BOT_TOKEN = XXXXX:XXXXXXXXX
APP_NAME = medtest

PG_USER = dbuser
PG_PWD = XXXXX
PG_HOST = 127.0.0.1
PG_DBNAME = mednote

MAEZZTRO_TID = XXXXX
```

### for google spreadsheet copy credentials.json and token.json to /opt/mednotebot/
credentials.json downloaded from google (api project)
token.json will be generated by google (mednotebot)
```sh
root@dcsrv05:~# tree /opt/mednotebot/cred/
/opt/mednotebot/cred/
├── credentials.json
├── token.json
└── token.json.expire
```
```sh
cd /opt/mednotebot/cred/ && chown 400 credentials.json && chown 400 token.json
```
